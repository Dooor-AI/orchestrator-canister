# Scripts - VetKD Demo

This folder contains JavaScript utility scripts for working with the VetKD system.

## ğŸ“ Files

### ğŸ” `vetkd_check.js`
**BLS12-381 Signature Verification**

Complete script to verify signatures generated by the VetKD canister. Implements multiple cryptographic verification strategies.

**Features:**
- âœ… BLS12-381 signature verification
- ğŸ” Multiple validation strategies
- ğŸ“Š Detailed debug and analysis
- ğŸ›¡ï¸ Elliptic curve point validation

**How to use:**
```bash
# 1. Install dependencies
npm install

# 2. Configure test data in the script
# (edit the constants at the top of the file)

# 3. Run verification
npm run check
```

**Required data:**
- `pkBlob`: BLS12-381 G2 public key (via `bls_public_key()`)
- `sigBlob`: BLS12-381 signature (via `sign_caller()`)
- `tskHex`: Transport secret key (hex)
- `payload`: Original signed data
- `callerText`: Caller principal

### ğŸ”‘ `gen_transport_key.js`
**Transport Key Generator**

Script to generate BLS12-381 G1 key pairs for use as transport keys in VetKD.

**Features:**
- ğŸ”‘ Random key generation
- ğŸ“¢ DFX-compatible format
- âœ… Automatic key validation
- ğŸ’¡ Usage examples

**How to use:**
```bash
# 1. Install dependencies
npm install

# 2. Run key generation
node scripts/gen_transport_key.js
```

**Output:**
```
ğŸ”‘ transport_secret_key (hex 64):
51624d5f6ffd4603ac8bff512c1e1122d1913e4fbd11ec7f91c6b8cbbbf8e4eb

ğŸ“¢ transport_public_key (48 B) â€“ paste in dfx:
vec {149;31;167;74;45;217;113;136;77;124;168;203;7;103;149;217;75;152;46;77;238;23;66;51;63;125;122;212;211;7;206;93;14;247;83;94;59;22;21;98;88;199;157;214;6;241;31;114}
```

## ğŸ› ï¸ Dependencies

### NPM Packages
```json
{
  "@noble/curves": "^1.9.6",
  "@dfinity/principal": "^3.1.0",
  "@noble/hashes": "^1.8.0"
}
```

### Installation
```bash
npm install
```

## ğŸ“‹ Workflow

### 1. Generate Transport Keys
```bash
node scripts/gen_transport_key.js
```

### 2. Use Public Key in Canister
```bash
dfx canister call vetkeys_demo sign_caller '( vec {1;2;3}, vec {149;31;167;74;...} )'
```

### 3. Verify Signature
```bash
# Edit vetkd_check.js with obtained data
npm run check
```

## ğŸ”§ Configuration

### package.json
```json
{
  "scripts": {
    "check": "node scripts/vetkd_check.js",
    "generate-key": "node scripts/gen_transport_key.js"
  }
}
```

### Data Structure

#### BLS12-381 G2 Public Key
- **Size**: 96 bytes
- **Format**: Escaped hexadecimal blob
- **Use**: Signature verification

#### BLS12-381 Signature
- **Size**: 192 bytes
- **Format**: Escaped hexadecimal blob
- **Components**: E1 (48 bytes) + E2 (96 bytes) + E3 (48 bytes)

#### Transport Key
- **Type**: BLS12-381 G1
- **Size**: 48 bytes (public) / 32 bytes (secret)
- **Use**: Derived key encryption

## ğŸ›¡ï¸ Security

### Best Practices
- ğŸ”’ **Never share secret keys**
- ğŸ” **Use random keys for each session**
- âœ… **Always validate public keys**
- ğŸ§ª **Test in local environment first**

### Implemented Validations
- âœ… Data size verification
- âœ… Elliptic curve point validation
- âœ… Valid coordinate verification
- âœ… Multiple verification strategies

## ğŸ› Troubleshooting

### Error: "signature blob â‰  192 bytes"
- Check if the signature copy-paste is correct
- Confirm there are no extra spaces or invalid characters

### Error: "Cannot find module '@noble/curves'"
```bash
npm install @noble/curves @dfinity/principal @noble/hashes
```

### Error: "G2 point validation failed"
- Verify the public key was obtained correctly
- Confirm the canister is working

### Verification fails
- Check if TSK corresponds to the public key
- Confirm test data is valid
- Use fresh data generated by `gen_transport_key.js`

## ğŸ“š Additional Resources

- [BLS12-381 Specification](https://tools.ietf.org/html/draft-irtf-cfrg-bls-signature-04)
- [@noble/curves Documentation](https://github.com/paulmillr/noble-curves)
- [VetKD Documentation](https://internetcomputer.org/docs/current/developer-docs/integrations/vetkd/)

---

**Scripts developed for the VetKD Demo project - Internet Computer** 